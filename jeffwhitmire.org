* Basic configurations

** Pull in other pieces of the starter kit
#+BEGIN_SRC emacs-lisp
  (starter-kit-load "ruby")
  (starter-kit-load "misc-recommended")
  (starter-kit-load "eshell")
  (starter-kit-load "lisp")
  (starter-kit-load "js")
  (starter-kit-load "yasnippet")
#+END_SRC

** General editor improvements
#+BEGIN_SRC emacs-lisp
  (menu-bar-mode t)
  (tool-bar-mode -1)
  (scroll-bar-mode 'right)

  ;; better smooth scrolling
  (setq redisplay-dont-pause t
        scroll-margin 1
        scroll-step 1
        scroll-conservatively 10000
        scroll-preserve-screen-position 1)

  (setq-default truncate-partial-width-windows nil ; truncate even with split screen
                truncate-lines nil                 ; Display continuous lines
                indent-tabs-mode nil               ; Do not use tabs for indentation
                indicate-empty-lines t             ; indicate empty lines
                imenu-auto-rescan t)

  (defalias 'yes-or-no-p 'y-or-n-p)  ; y/n instead of yes/no
  (defalias 'auto-tail-revert-mode 'tail-mode)

  (setq backup-inhibited t      ;; Disable backups
        auto-save-default nil)  ;; disable auto save

  (setq search-highlight t)
  (transient-mark-mode t)
  (pending-delete-mode t)

  (custom-set-variables
   '(blink-cursor-mode nil)
   '(column-number-mode t)
   '(size-indication-mode t)
   '(display-time-mode nil)
   '(inhibit-startup-screen t)
   '(initial-scratch-message ";; This is your chance to scratch where it itches... in a manner of speaking")
   '(tab-width 2)
   '(track-eol t))


#+END_SRC
** OSX Specific stuff
#+BEGIN_SRC emacs-lisp
  ;; OSX specific settings
  (setq mac-option-key-is-meta nil
        mac-command-key-is-meta t
        mac-command-modifier 'meta
        mac-option-modifier 'none
        x-select-enable-clipboard t)

  ;; tweak OSX copy/paste keybindings
  (global-set-key (kbd "M-w") 'jw-kill-buffer-and-frame)
  (global-set-key (kbd "M-c") 'kill-ring-save)
  (global-set-key (kbd "M-v") 'yank)

  ;; ctrl-tab to switch emacs windows
  (global-set-key [C-tab] 'next-multiframe-window)

  ;; custom kill window function
  (defun jw-kill-buffer-and-frame ()
    "Close the frame in a manner consistent with OSX M-w and also kill the buffer"
    (interactive)
    (when (yes-or-no-p "Are you sure you want to delete the frame?")
      (kill-buffer)
      (delete-frame)))
#+END_SRC

** mode-line configuration
#+BEGIN_SRC emacs-lisp
  (require 'smart-mode-line)
  (sml/setup)
#+END_SRC

** undo/redo
#+BEGIN_SRC emacs-lisp
  (require 'redo+)

  (global-set-key (kbd "M-z") 'undo)
  (global-set-key (kbd "M-Z") 'redo)
#+END_SRC

** whitespace configuration
#+BEGIN_SRC emacs-lisp
  (setq whitespace-line-column 120
        whitespace-style '(face trailing tabs lines-tail space-before-tab::space
                                space-after-tab::space tab-mark)
        whitespace-action '(cleanup auto-cleanup report-on-bogus)
        whitespace-display-mappings '((newline-mark 10 [182 10])
                                      (tab-mark 9 [8614 9] [92 9])))

  (global-whitespace-mode)
  (add-hook 'before-save-hook 'whitespace-cleanup)
#+END_SRC

** line numbering
#+BEGIN_SRC emacs-lisp
  ;;(require 'linum+)

  (global-linum-mode t)
  (global-visual-line-mode 1)
#+END_SRC
** themes
#+BEGIN_SRC emacs-lisp
  (add-to-list 'custom-theme-load-path "~/.emacs.d/src/themes/")
  (setq custom-safe-themes t)
  (load-theme 'calm-forest)
#+END_SRC

** font/face setup
#+BEGIN_SRC emacs-lisp

  (define-key global-map (kbd "C-+") 'text-scale-increase)
  (define-key global-map (kbd "C--") 'text-scale-decrease)

  ;; emoji-display
  (require 'emoji-display)
  (emoji-display-mode)

  ;; figlet for more fun
  (require 'figlet)
#+END_SRC

** improved navigation
#+BEGIN_SRC emacs-lisp

  ;; Change windmove binding to "meta" so I can enable shift + arrow
  ;; keys to select text
  (windmove-default-keybindings 'hyper)
  (setq shift-select-mode t)

  (defun smarter-move-beginning-of-line (arg)
    "Move point back to indentation of beginning of line.

  Move point to the first non-whitespace character on this line.
  If point is already there, move to the beginning of the line.
  Effectively toggle between the first non-whitespace character and
  the beginning of the line.

  If ARG is not nil or 1, move forward ARG - 1 lines first.  If
  point reaches the beginning or end of the buffer, stop there."
    (interactive "^p")
    (setq arg (or arg 1))

    ;; Move lines first
    (when (/= arg 1)
      (let ((line-move-visual nil))
        (forward-line (1- arg))))

    (let ((orig-point (point)))
      (back-to-indentation)
      (when (= orig-point (point))
        (move-beginning-of-line 1))))

  ;; remap C-a to `smarter-move-beginning-of-line'
  (global-set-key [remap move-beginning-of-line]
                  'smarter-move-beginning-of-line)

  ;; regular join-line joins the line below the point to the line below
  ;; jw-join-line joins the current line to the line above
  (defun jw-join-line ()
    "Join the current line with the one below"
    (interactive)
    (forward-line)
    (join-line))
  (global-set-key (kbd "C-M-j") 'join-line)
  (global-set-key (kbd "C-S-j") 'jw-join-line)

  ;; Copy current line (or selected region)
  (defun duplicate-line-or-region (&optional n)
    "Duplicate current line, or region if active.
  With argument N, make N copies.
  with negative N, comment our original line and use the absolute value."
    (interactive "*p")
    (let ((use-region (use-region-p)))
      (save-excursion
        (let ((text (if use-region ; Get region if active, otherwise line
                        (buffer-substring (region-beginning) (region-end))
                      (prog1 (thing-at-point 'line)
                        (end-of-line)
                        (if (< 0 (forward-line 1)) ; Go to beginning of next line or make new one
                            (newline))))))
          (dotimes (i (abs (or n 1))) ; insert N times, defaulting to 1
            (insert text))))
      (if use-region nil ; only if we are working with a line (not a region)
        (let ((pos (- (point) (line-beginning-position)))) ; save column
          (if (> 0 n) ; comment out original if negative argument
              (comment-region (line-beginning-position) (line-end-position)))
          (forward-line 1)
          (forward-char pos)))))
  (global-set-key (kbd "C-S-d") 'duplicate-line-or-region)
  (global-set-key (kbd "C-S-k") 'kill-whole-line) ; kill line regardless of position

#+END_SRC

* emacs tool/environment setup
** org-mode setup
  #+BEGIN_SRC emacs-lisp
    (require 'org-compat)

    (setq org-agenda-inhibit-startup nil
          org-agenda-compact-blocks t
          org-agenda-dim-blocked-tasks t
          org-agenda-include-diary t
          org-agenda-restore-windows-after-quit t
          org-agenda-skip-deadline-if-done t
          org-agenda-skip-timestamp-if-done t
          org-agenda-tags-column -120
          org-agenda-window-setup 'other-window
          org-completion-use-ido t
          org-cycle-separator-lines 0
          org-default-notes-file "~/.emacs.d/org/captives.org"
          org-default-priority 67
          org-enforce-todo-checkbox-dependencies t
          org-enforce-todo-dependencies t
          org-habit-graph-column 50
          org-habit-show-all-today t
          org-inlinetask-show-first-star t
          org-insert-heading-respect-content t
          org-lowest-priority 70
          org-modules '(org-checklist org-ctags org-docview org-expiry org-git-link
                                      org-gnus org-habit org-id org-info org-jsinfo org-toc)
          org-startup-folded 'content
          org-startup-indented t
          org-support-shift-select t
          org-use-speed-commands t
          org-src-fontify-natively 't)

    (custom-set-variables
     '(org-babel-load-languages (quote ((emacs-lisp . t) (ruby . r))))
     '(org-confirm-babel-evaluate))

    (global-set-key (kbd "C-c a") 'org-agenda)

    (defun jw/mark-subtree-done ()
      (interactive)
      (org-mark-subtree)
      (let ((limit (point)))
        (save-excursion
          (exchange-point-and-mark)
          (while (> (point) limit)
            (org-todo "DONE")
            (outline-previous-visible-heading 1))
          (org-todo "DONE"))))

    (defun jw-org-mode-hook ()
      (local-set-key (kbd "M-n") 'outline-next-visible-heading)
      (local-set-key (kbd "M-p") 'outline-previous-visible-heading)
      (local-set-key (kbd "M-L") 'org-toggle-link-display)

      (org-set-local 'yas/trigger-key [tab])
      (define-key yas/keymap [tab] 'yas/next-field-group))

    (add-hook 'org-mode-hook 'jw-org-mode-hook)
  #+END_SRC

** ido-mode/smex setup
More ido setup and configuration can be found at http://www.masteringemacs.org/articles/2010/10/10/introduction-to-ido-mode/

#+BEGIN_SRC emacs-lisp
  (require 'flx-ido)
  (ido-mode 1)
  (ido-everywhere 1)
  (flx-ido-mode 1)

  (setq ido-use-faces nil
        ido-use-filename-at-point 'guess
        ido-file-extensions-order '(".org" ".el" ".rb" ".yml"))

  ;; smex setup
  (setq smex-auto-update nil
        smex-flex-matching t
        smex-history-length 15
        smex-prompt-string "You Rang? "
        smex-safe-file (concat user-emacs-directory ".smex-items"))

  (defun smex-update-after-load (unused)
    (when (boundp 'smex-cache)
      (smex-update)))
  (add-hook 'after-load-functions 'smex-update-after-load)

  (require 'smex)
  (smex-initialize)
  (global-set-key (kbd "M-x") 'smex)
  (global-set-key (kbd "M-X") 'smex-major-mode-commands)
  (global-set-key (kbd "C-c C-c M-x") 'execute-extended-command) ; old M-x definition

  (defadvice ido-set-matches-1 (after ido-acronym-matches activate)
    (if (> (length ido-text) 1)
        (let ((regex (concat "^" (mapconcat 'char-to-string ido-text "[^-]*-")
                             "[^-]*$")))
          (setq ad-return-value
                (append (reverse
                         (remove-if-not
                          (lambda (i)
                            (string-match regex i)) items))
                        ad-return-value)))))

  (defadvice smex (around space-inserts-hyphen activate compile)
    (let ((ido-cannot-complete-command
           '(lambda ()
              (interactive)
              (if (string= " " (this-command-keys))
                  (insert ?-)
                (funcall ,ido-cannot-complete-command)))))
      ad-do-it))
#+END_SRC
** dired improvements
#+BEGIN_SRC emacs-lisp
  ;; dired setup
  (setq vc-follow-symlinks t)

  ;; OSX ls doesn't support --dired, use gnu from homebrew instead
  ;;(setq insert-directory-program "gls"
  ;;      dired-use-ls-dired t)
#+END_SRC
** auto-complete setup
#+BEGIN_SRC emacs-lisp
  (require 'auto-complete-config)
  ;(add-to-list 'ac-dictionary-dictionaries "~/.emacs.d/.cask/24.3.50.1/elpa/auto-complete-20140322.321/dict")
  (ac-config-default)
  (add-to-list 'ac-modes 'enh-ruby-mode)
  (add-to-list 'ac-modes 'web-mode)
#+END_SRC

** shell configuration setup
#+BEGIN_SRC emacs-lisp

  ;; To get rid of Weird color escape sequences in Emacs.
  ;; Instruct Emacs to use emacs term-info not system term info
  ;; http://stackoverflow.com/questions/8918910/weird-character-zsh-in-emacs-terminal
  (setq system-uses-terminfo nil)

  ;; Prefer utf-8 encoding
  (prefer-coding-system 'utf-8)

  ;;;; ansi colorization
  (require 'ansi-color)
  (add-hook 'shell-mode-hook 'ansi-color-for-comint-mode-on)
  (defun colorize-compilation-buffer ()
    (interactive)
    (toggle-read-only)
    (ansi-color-apply-on-region (point-min) (point-max))
    (toggle-read-only))
  (add-hook 'compilation-filter-hook 'colorize-compilation-buffer)

  ;;
  ;; shell script setup
  ;;
  (eval-after-load 'sh-mode
    '(progn
       (define-key sh-mode-map (kbd "RET") 'reindent-then-newline-and-indent)))

  ;;
  ;; multi-term setup
  ;;
  (require 'multi-term)
  (setq multi-term-program "/user/local/bin/zsh")

  (add-hook 'comint-output-filter-functions
            'shell-strip-ctrl-m nil t)

  ;; Set executable path to match what it is outside of emacs
  (when (memq window-system '(mac ns))
      (exec-path-from-shell-initialize))

  ;;
  ;; eshell setup
  ;;
  (setq eshell-cmpl-cycle-completions nil
        eshell-save-history-on-exit t
        eshell-buffer-shorthand t
        eshell-cmpl-dir-ignore "\\`\\(\\.\\.?\\|CVS\\|\\.svn\\|\\.git\\)/\\'")

#+END_SRC
** server mode setup
#+BEGIN_SRC emacs-lisp
  (if (not server-mode)
      (server-start nil t))

#+END_SRC
* development environment configuration
** generic development
#+BEGIN_SRC emacs-lisp

  ;; rebind hippie-expand
  (global-set-key (kbd "C-?") 'hippie-expand)

  (global-unset-key (kbd "M-/"))
  (global-set-key (kbd "M-/") 'comment-or-uncomment-region)

  (global-set-key "\C-xy" 'revert-buffer)

  ;; reformat the entire buffer
  (defun indent-buffer ()
    "indent whole buffer"
    (interactive)
    (delete-trailing-whitespace)
    (indent-region (point-min) (point-max) nil)
    (untabify (point-min) (point-max)))
  (global-set-key (kbd "C-M-|") 'indent-buffer)
#+END_SRC
** git setup
#+BEGIN_SRC emacs-lisp
  ;;;; git setup

  (when (window-system)
    (require 'git-gutter-fringe))

  (after 'git-gutter-mode-autoloads
         (global-git-gutter-mode +1)
         (setq-default indicate-buffer-boundaries 'left)
         (setq-default indicate-empty-lines +1)

         (add-hook 'enh-ruby-mode-hook 'git-gutter-mode)
         (add-hook 'web-mode-hook 'git-gutter-mode)
         (add-hook 'css-mode-hook 'git-gutter-mode)
         (add-hook 'javascript-mode-hook 'git-gutter-mode)
         (add-hook 'coffee-mode-hook 'git-gutter-mode)
         (add-hook 'js2-mode-hook 'git-gutter-mode)
         (add-hook 'yaml-mode-hook 'git-gutter-mode)
         (add-hook 'emacs-lisp-mode-hook 'git-gutter-mode)
         (add-hook 'thrift-mode-hook 'git-gutter-mode)

         ;; (dolist
         ;;     (hook '(emacs-lisp-mode-hook
         ;;             enh-ruby-mode-hook
         ;;             js2-mode-hook
         ;;             lisp-mode-hook
         ;;             yaml-mode-hook))
         ;;   (add-hook hook 'git-gutter-mode))

         (global-set-key (kbd "C-x C-g") 'git-gutter:toggle)
         (global-set-key (kbd "C-x v =") 'git-gutter:popup-hunk)
         (global-set-key (kbd "C-x p") 'git-gutter:previous-hunk)
         (global-set-key (kbd "C-x n") 'git-gutter:next-hunk)
         (global-set-key (kbd "C-x r") 'git-gutter:revert-hunk))

  (global-set-key (kbd "C-x v p") 'git-messenger:popup-message)

  (global-set-key (kbd "C-c g") 'magit-status)

  ;; shamlessly stolen from http://whattheemacsd.com/setup-magit.el-01.html
  (defadvice magit-status
      (around magit-fullscreen activate)
    (window-configuration-to-register :magit-fullscreen)
    ad-do-it
    (delete-other-windows))

  (defun magit-quit-session ()
    "Restores the previous window configuration and kills the magit buffer"
    (interactive)
    (kill-buffer)
    (jump-to-register :magit-fullscreen))

  (define-key magit-status-mode-map (kbd "q") 'magit-quit-session)

#+END_SRC
** smartparans configuration
#+BEGIN_SRC emacs-lisp
  (require 'smartparens-config)
  (require 'smartparens-ruby)

  (smartparens-global-mode t)
  (show-smartparens-global-mode t)

  (--each sp--html-modes
    (eval-after-load (symbol-name it) '(require 'smartparens-html)))

  (sp-with-modes '(rhtml-mode)
                 (sp-local-pair "<" ">")
                 (sp-local-pair "<%" "%>"))

  (sp-pair "'" nil :unless '(sp-point-after-word-p))
  (sp-with-modes sp--lisp-modes
    (sp-local-pair "'" nil :actions nil)
    (sp-local-pair "`" "'" :when '(sp-in-string-p))
    (sp-local-pair "(" nil :bind "C-("))

  (sp-with-modes sp--html-modes
    (sp-local-pair "<%" "%>"))

  (sp-local-pair 'minibuffer-inactive-mode "'" nil :actions nil)

  (define-key emacs-lisp-mode-map (kbd ")") 'sp-up-sexp)

  ;; (define-key sp-keymap (kbd "C-M-f") 'sp-forward-sexp)
  ;; (define-key sp-keymap (kbd "C-M-b") 'sp-backward-sexp)

  ;; (define-key sp-keymap (kbd "C-M-d") 'sp-down-sexp)
  ;; (define-key sp-keymap (kbd "C-M-a") 'sp-backward-down-sexp)
  ;; (define-key sp-keymap (kbd "C-S-a") 'sp-beginning-of-sexp)
  ;; (define-key sp-keymap (kbd "C-S-e") 'sp-end-of-sexp)

  ;; (define-key sp-keymap (kbd "C-M-e") 'sp-up-sexp)
  ;; (define-key sp-keymap (kbd "C-M-u") 'sp-backward-up-sexp)
  ;; (define-key sp-keymap (kbd "C-M-t") 'sp-transpose-sexp)

  ;; (define-key sp-keymap (kbd "C-M-n") 'sp-next-sexp)
  ;; (define-key sp-keymap (kbd "C-M-p") 'sp-previous-sexp)

  ;; (define-key sp-keymap (kbd "C-M-k") 'sp-kill-sexp)
  ;; (define-key sp-keymap (kbd "C-M-w") 'sp-copy-sexp)

  ;; (define-key sp-keymap (kbd "M-<delete>") 'sp-unwrap-sexp)
  ;; (define-key sp-keymap (kbd "M-<backspace>") 'sp-backward-unwrap-sexp)

  ;; (define-key sp-keymap (kbd "C-<right>") 'sp-forward-slurp-sexp)
  ;; (define-key sp-keymap (kbd "C-<left>") 'sp-forward-barf-sexp)
  ;; (define-key sp-keymap (kbd "C-M-<left>") 'sp-backward-slurp-sexp)
  ;; (define-key sp-keymap (kbd "C-M-<right>") 'sp-backward-barf-sexp)

  ;; (define-key sp-keymap (kbd "M-D") 'sp-splice-sexp)
  ;; (define-key sp-keymap (kbd "C-M-<delete>") 'sp-splice-sexp-killing-forward)
  ;; (define-key sp-keymap (kbd "C-M-<backspace>") 'sp-splice-sexp-killing-backward)
  ;; (define-key sp-keymap (kbd "C-S-<backspace>") 'sp-splice-sexp-killing-around)

  ;; (define-key sp-keymap (kbd "C-]") 'sp-select-next-thing-exchange)
  ;; (define-key sp-keymap (kbd "C-<left_bracket>") 'sp-select-previous-thing)
  ;; (define-key sp-keymap (kbd "C-M-]") 'sp-select-next-thing)

  ;; (define-key sp-keymap (kbd "M-F") 'sp-forward-symbol)
  ;; (define-key sp-keymap (kbd "M-B") 'sp-backward-symbol)

  ;; (define-key sp-keymap (kbd "H-t") 'sp-prefix-tag-object)
  ;; (define-key sp-keymap (kbd "H-p") 'sp-prefix-pair-object)
  ;; (define-key sp-keymap (kbd "H-s c") 'sp-convolute-sexp)
  ;; (define-key sp-keymap (kbd "H-s a") 'sp-absorb-sexp)
  ;; (define-key sp-keymap (kbd "H-s e") 'sp-emit-sexp)
  ;; (define-key sp-keymap (kbd "H-s p") 'sp-add-to-previous-sexp)
  ;; (define-key sp-keymap (kbd "H-s n") 'sp-add-to-next-sexp)
  ;; (define-key sp-keymap (kbd "H-s j") 'sp-join-sexp)
  ;; (define-key sp-keymap (kbd "H-s s") 'sp-split-sexp)

  ;; ;;;; Smartparens
  ;; (require 'smartparens-config)           ; Setup standard configuration

  ;; (stante-after smartparens
  ;;   (setq sp-autoskip-closing-pair 'always
  ;;         ;; Don't kill the entire symbol on C-k
  ;;         sp-hybrid-kill-entire-symbol nil)

  ;;   ;; Smartparens bindings
  ;;   (let ((map smartparens-mode-map))
  ;;     ;; Movement and navigation
  ;;     (define-key map (kbd "C-M-f") #'sp-forward-sexp)
  ;;     (define-key map (kbd "C-M-b") #'sp-backward-sexp)
  ;;     (define-key map (kbd "C-M-u") #'sp-backward-up-sexp)
  ;;     (define-key map (kbd "C-M-d") #'sp-down-sexp)
  ;;     (define-key map (kbd "C-M-p") #'sp-backward-down-sexp)
  ;;     (define-key map (kbd "C-M-n") #'sp-up-sexp)
  ;;     ;; Deleting and killing
  ;;     (define-key map (kbd "C-M-k") #'sp-kill-sexp)
  ;;     (define-key map (kbd "C-M-w") #'sp-copy-sexp)
  ;;     ;; Depth changing
  ;;     (define-key map (kbd "M-s") #'sp-splice-sexp)
  ;;     (define-key map (kbd "M-<up>") #'sp-splice-sexp-killing-backward)
  ;;     (define-key map (kbd "M-<down>") #'sp-splice-sexp-killing-forward)
  ;;     (define-key map (kbd "M-r") #'sp-splice-sexp-killing-around)
  ;;     (define-key map (kbd "M-?") #'sp-convolute-sexp)
  ;;     ;; Barfage & Slurpage
  ;;     (define-key map (kbd "C-)")  #'sp-forward-slurp-sexp)
  ;;     (define-key map (kbd "C-<right>") #'sp-forward-slurp-sexp)
  ;;     (define-key map (kbd "C-}")  #'sp-forward-barf-sexp)
  ;;     (define-key map (kbd "C-<left>") #'sp-forward-barf-sexp)
  ;;     (define-key map (kbd "C-(")  #'sp-backward-slurp-sexp)
  ;;     (define-key map (kbd "C-M-<left>") #'sp-backward-slurp-sexp)
  ;;     (define-key map (kbd "C-{")  #'sp-backward-barf-sexp)
  ;;     (define-key map (kbd "C-M-<right>") #'sp-backward-barf-sexp)
  ;;     ;; Miscellaneous commands
  ;;     (define-key map (kbd "M-S") #'sp-split-sexp)
  ;;     (define-key map (kbd "M-J") #'sp-join-sexp)
  ;;     (define-key map (kbd "C-M-t") #'sp-transpose-sexp))

  ;;   ;; Some additional bindings for strict mode
  ;;   (let ((map smartparens-strict-mode-map))
  ;;     (define-key map (kbd "M-q") #'sp-indent-defun)
  ;;     (define-key map (kbd "C-j") #'sp-newline)))

  ;; (smartparens-global-mode)
  ;; (show-smartparens-global-mode)          ; Show parenthesis
#+END_SRC
** emacs-lisp configuration
#+BEGIN_SRC emacs-lisp
  ;; Cask files are emacs-lisp
  (add-to-list 'auto-mode-alist '("Cask$" . emacs-lisp-mode))

  (define-key emacs-lisp-mode-map (kbd "C-c v") 'eval-buffer)
  (define-key read-expression-map (kbd "TAB") 'lisp-complete-symbol)
  (define-key lisp-mode-shared-map (kbd "RET") 'reindent-then-newline-and-indent)

  ;; Remove the .elc file when saving a .el file
  (defun remove-elc-on-save ()
    (interactive)
    (if (file-exists-p (concat buffer-file-name "c"))
        (delete-file (concat buffer-file-name "c"))))

  (add-hook 'after-save-hook 'remove-elc-on-save)

  ;; Automatically byte compile a .el file on save
  (defun auto-recomple-el-buffer ()
    (interactive)
    (when (and (eq major-mode 'emacs-lisp-mode)
               (file-exists-p (byte-compile-dest-file buffer-file-name)))
      (byte-compile-file buffer-file-name)))

  (add-hook 'after-save-hook 'auto-recomple-el-buffer)

#+END_SRC

** ruby configuration
#+BEGIN_SRC emacs-lisp
  (require 'chruby)
  (chruby "ruby-2.1.1")

  (require 'bundler)

  (require 'robe)
  (add-hook 'enh-ruby-mode 'robe-mode)
  (push 'ac-source-robe ac-sources)
  (add-hook 'robe-mode-hook 'ac-robe-setup)

  (defun ruby-interpolate ()
    "In a double quoted string, interpolate."
    (interactive)
    (insert "#")
    (when (and
           (looking-back "\".*")
           (looking-at ".*\""))
      (insert "{}")
      (backward-char 1)))

  (require 'compile)

  (defun jw-enh-ruby-mode-hook ()
    "Hooks for enh-ruby-mode"
    (define-key enh-ruby-mode-map (kbd "RET") newline-and-indent)
    (define-key enh-ruby-mode-map (kbd "TAB") 'indent-for-tab-command)
    (define-key enh-ruby-mode-map (kbd "#") 'ruby-interpolate)
    (define-key enh-ruby-mode-map (kbd "C-M-h") 'backward-kill-word)
    (define-key enh-ruby-mode-map (kbd "C-c , ,") 'jw-open-spec-other-buffer)
    (set (make-local-variable 'outline-level) 'ruby-outline-level)
    (set (make-local-variable 'outline-regexp)
         (rx (group (* " "))
             bow
             (or "begin" "case" "class" "def" "else" "elsif"
                 "ensure" "if" "module" "rescue" "when" "unless"
                 "describe" "context" "it" "before")
             eow))
    (outline-minor-mode))
  (add-hook 'enh-ruby-mode-hook 'jw-enh-ruby-mode-hook)

  (after 'enh-ruby-mode-autoloads
    ;; work around possible ELPA bug
    (ignore-errors (require 'ruby-compilation)))

  (require 'highlight-indentation)
  (add-hook 'enh-ruby-mode-hook 'highlight-indentation-current-column-mode)
  (add-hook 'coffee-mode-hook 'highlight-indentation-current-column-mode)

  ;; set up outline mode
  (defun ruby-outline-level ()
    (or (and (match-string 1)
             (or (cdr (assoc (match-string 1) outline-heading-alist))
                 (- (match-end 1) (match-beginning 1))))
        (cdr (assoc (match-string 0) outline-heading-alist))
        (- (match-end 0) (match-beginning 0))))

  (add-hook 'enh-ruby-mode-hook
            (lambda ()
              (define-key enh-ruby-mode-map (kbd "C-m") newline-and-indent)
              (define-key enh-ruby-mode-map (kbd "RET") newline-and-indent)
              (define-key enh-ruby-mode-map (kbd "TAB") 'indent-for-tab-command)
              (define-key enh-ruby-mode-map (kbd "#") 'ruby-interpolate)
              (define-key enh-ruby-mode-map (kbd "C-M-h") 'backward-kill-word)
              (define-key enh-ruby-mode-map (kbd "C-c , ,") 'jw-open-spec-other-buffer)
              (set (make-local-variable 'outline-level) 'ruby-outline-level)
              (set (make-local-variable 'outline-regexp)
                   (rx (group (* " "))
                       bow
                       (or "begin" "case" "class" "def" "else" "elsif"
                           "ensure" "if" "module" "rescue" "when" "unless"
                           "describe" "context" "it" "before")
                       eow))
              (outline-minor-mode)))

  (defun outline-cycle-fast ()
    "Emulates 2 hits of the outline-cycle, which is correct 90% of the time"
    (interactive)

    (hide-subtree)
    (show-entry)
    (show-children)
    (setq this-command 'outline-cycle-children))

  (add-hook 'outline-minor-mode-hook
            (lambda ()
              (require 'outline-magic)

              (define-key outline-minor-mode-map (kbd "M-o M-o") 'outline-cycle)
              (define-key outline-minor-mode-map (kbd "M-o o") 'outline-cycle-fast)))

  (require 'ruby-tools)

#+END_SRC

** web-mode configuration
#+BEGIN_SRC emacs-lisp
  (defun jw-web-mode-hook ()
    "Hooks for web-mode"
    (setq web-mode-markup-indent-offset 2
          web-mode-css-indent-offset 2
          web-mode-code-indent-offset 2
          web-mode-indent-style 2
          web-mode-style-padding 1
          web-mode-script-padding 1
          web-mode-block-padding 0
          web-mode-comment-style 2
          web-mode-enable-block-face t
          web-mode-enable-part-face t
          web-mode-enable-comment-keywords t
          web-mode-enable-current-element-highlight t)
    (local-set-key (kbd "RET") 'newline-and-indent)
    (define-key web-mode-map (kbd "C-m") 'newline-and-indent))
  (add-hook 'web-mode-hook 'jw-web-mode-hook)
#+END_SRC

*** css/scss configuration
#+BEGIN_SRC emacs-lisp
  ;; css-mode
  (autoload 'css-mode "css-mode" nil t)
  (add-to-list 'auto-mode-alist '("\\.css$" . css-mode))
  (setq cssm-indent-function #'cssm-c-style-indenter)

  ;; setup scss mode
  (when (require 'scss-mode nil t)
    (setq scss-compile-at-save nil)
    (setq exec-path (cons (expand-file-name "~/.gem/ruby/2.0.0/bin") exec-path))
    (autoload 'scss-mode "scss-mode")
    (add-to-list 'auto-mode-alist '("\\.scss\\'" . scss-mode))
    (add-to-list 'ac-modes 'scss-mode))

  (defun brace-ret-brace ()
    (interactive)
    (insert "{")
    (newline-and-indent)
    (newline-and-indent)
    (insert "}")
    (indent-for-tab-command)
    (newline-and-indent)
    (newline-and-indent)
    (previous-line)
    (previous-line)
    (previous-line)
    (indent-for-tab-command))

  (defun jw-css-mode-hook ()
    "Hooks for css-mode"
    (setq css-indent-offset 2)
    (define-key css-mode-map "M-{" 'brace-ret-brace)
    (local-set-key (kbd "RET") 'newline-and-indent))

  (add-hook 'css-mode-hook 'jw-css-mode-hook)

  (eval-after-load 'auto-complete
    '(progn
       (dolist (hook '(css-mode-hook sass-mode-hook scss-mode-hook))
         (add-hook hook 'ac-css-mode-setup))))

#+END_SRC

*** skewer mode
#+BEGIN_SRC emacs-lisp
(skewer-setup)
#+END_SRC
** coffeescript config
#+BEGIN_SRC emacs-lisp
  ;;
  ;; coffeescript setup
  ;;
  (require 'coffee-mode)
  (defun jw-coffee-setup ()
    (interactive)
    (message "Loading coffee-mode hook")

    ;; set up tab handling
    (make-local-variable 'tab-width)
    (setq tab-width 2
          coffee-tab-width 2)

    ;; set M-r to compile buffer
    (define-key coffee-mode-map (kbd "M-r") 'coffee-compile-buffer)

    ;; compile coffee files on save
    (and (file-exists-p (buffer-file-name))
         (file-exists-p (coffee-compiled-file-name))
         (coffee-cos-mode t)))
  (add-hook 'coffee-mode-hook 'jw-coffee-setup)


#+END_SRC

** javascript config
#+BEGIN_SRC emacs-lisp
  ;;
  ;; javascript setup
  ;;
  (autoload 'js2-mode "js2" nil t)
  (add-to-list 'auto-mode-alist '("\\.js$" . js2-mode))
  (after 'js2-mode-autoloads
         (require 'js2-refactor)

         (setq js2-use-font-lock-faces t
               js2-mode-must-byte-compile nil
               js2-basic-offset 2
               js2-indent-on-enter-key t
               js2-auto-indent-p t
               js2-bounce-indent-p nil)

         (add-hook 'js2-mode-hook
                   '(lambda ()
                      (setq mode-name "JS2")
                      (make-local-variable 'yas-extra-modes)
                      (add-to-list 'yas-extra-modes 'javascript-mode)
                      (yas-minor-mode 1)))
         (js2-imenu-extras-setup)
       (add-to-list 'auto-mode-alist '("\\.js$" . js2-mode))
       (add-to-list 'auto-mode-alist '("\\.json$" . js2-mode)))


#+END_SRC
